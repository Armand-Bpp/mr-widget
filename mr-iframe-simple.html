<!doctype html> <html lang="fr"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width,initial-scale=1" /> <title>Choix Point Relais — Iframe (Leaflet)</title> <!-- Leaflet CSS --> <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" /> <style> :root { font-family: Inter, Arial, Helvetica, sans-serif; } body { margin: 0; padding: 12px; background: #fff; color: #111; } #controls { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; } #map { height: 360px; border: 1px solid #e6e6e6; border-radius: 6px; } #list { max-height: 220px; overflow: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 6px; } .shop { padding: 10px; border-bottom: 1px solid #f2f2f2; cursor: pointer; display: flex; justify-content: space-between; align-items: center; } .shop:last-child { border-bottom: 0; } .shop:hover { background: #fafafa; } .shop .meta { font-size: 13px; color: #555; } .btn { background: #0b76ef; color: white; border: 0; padding: 6px 10px; border-radius: 4px; cursor: pointer; } .btn:active { transform: translateY(1px); } #status { color: #666; font-size: 13px; } .small { font-size: 12px; color: #888; } </style> </head> <body> <!-- CONFIGURATION : modifie ici si besoin --> <script> const CONFIG = { USE_BACKEND: false, // false = mock (pas de backend) BACKEND_URL: '', // si USE_BACKEND=true mettre l'URL de ton backend PARENT_ORIGIN: '*' // pour la prod remplace par l'origin exact de ta page Square (ex: 'https://www.maboutique.square.site') }; </script> <div id="controls"> <label for="zip">Code postal&nbsp;</label> <input id="zip" type="text" placeholder="75001" style="padding:6px;border:1px solid #ddd;border-radius:4px" /> <button id="search" class="btn">Rechercher</button> <div id="status" style="margin-left:12px">mode: <span id="mode">mock</span></div> </div> <div id="map"></div> <div id="list"></div> <!-- Leaflet JS --> <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> <script> // --- Utilitaires --- function escapeHtml(s) { if (!s) return ''; return String(s).replace(/[&<>"']/g, function(c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]; }); } // Mock data function (développement / test) function mockResults(zip) { return [ { id: 'MR-001', name: 'Boulangerie Dupont', address: '12 rue de la Gare', zip: zip, city: 'Paris', lat: 48.8566, lng: 2.3522, type: 'Relais', opening: '9h-19h' }, { id: 'MR-002', name: 'Presse Victor', address: '5 avenue Victor Hugo', zip: zip, city: 'Paris', lat: 48.8600, lng: 2.3450, type: 'Relais', opening: '7h-20h' }, { id: 'MR-003', name: 'Locker Station X', address: '30 rue des Fleurs', zip: zip, city: 'Paris', lat: 48.8510, lng: 2.3600, type: 'Locker', opening: '24/7' } ]; } // --- Initialisation carte Leaflet --- const map = L.map('map', { attributionControl: false }).setView([48.8566, 2.3522], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map); const markers = L.layerGroup().addTo(map); let currentShops = []; // Affiche mode document.getElementById('mode').textContent = CONFIG.USE_BACKEND ? 'backend' : 'mock'; // Requête vers le backend (si configuré) async function fetchShops(zip) { if (!CONFIG.USE_BACKEND) { return mockResults(zip); } try { const url = new URL('/api/parcelshops', CONFIG.BACKEND_URL).toString() + '?zip=' + encodeURIComponent(zip); const res = await fetch(url, { method: 'GET', credentials: 'omit' }); if (!res.ok) { const txt = await res.text(); throw new Error('Erreur backend: ' + res.status + ' ' + txt); } const json = await res.json(); if (Array.isArray(json.shops)) return json.shops; if (Array.isArray(json)) return json; if (json && Array.isArray(json.data)) return json.data; return json.shops || json.results || []; } catch (err) { throw err; } } // Render markers + liste function renderShops(shops) { markers.clearLayers(); const list = document.getElementById('list'); list.innerHTML = ''; const bounds = []; shops.forEach(function(s, idx) { const lat = parseFloat(s.lat || s.latitude); const lng = parseFloat(s.lng || s.longitude); if (!lat || !lng) return; bounds.push([lat, lng]); const marker = L.marker([lat, lng]).addTo(markers); const popupHtml = '' + '<strong>' + escapeHtml(s.name) + '</strong><br/>' + escapeHtml(s.address || '') + '<br/>' + escapeHtml(s.zip || '') + ' ' + escapeHtml(s.city || '') + '<br/>' + '<div class="small">' + escapeHtml(s.type || '') + (s.opening ? ' • ' + escapeHtml(s.opening) : '') + '</div>' + '<div style="margin-top:6px"><button data-idx="' + idx + '" class="btn select-popup">Sélectionner</button></div>'; marker.bindPopup(popupHtml); const item = document.createElement('div'); item.className = 'shop'; item.dataset.idx = idx; item.innerHTML = '' + '<div><strong>' + escapeHtml(s.name) + '</strong>' + '<div class="meta">' + escapeHtml(s.address || '') + ' • ' + escapeHtml(s.zip || '') + ' ' + escapeHtml(s.city || '') + '</div>' + '</div>' + '<div><button data-idx="' + idx + '" class="btn">Sélectionner</button></div>'; item.addEventListener('click', function() { marker.openPopup(); map.panTo([lat, lng]); }); list.appendChild(item); }); if (bounds.length) { map.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 }); } // attach select handlers document.querySelectorAll('.shop .btn, .select-popup').forEach(function(btn) { btn.addEventListener('click', function(ev) { ev.stopPropagation(); var idx = parseInt(btn.dataset.idx, 10); chooseShop(idx); }); }); } // Envoyer la sélection au parent (page Square) function chooseShop(idx) { const shop = currentShops[idx]; if (!shop) return; const targetOrigin = CONFIG.PARENT_ORIGIN || '*'; window.parent.postMessage({ type: 'mr_selected', data: shop }, targetOrigin); alert('Point relais choisi:\n' + (shop.name || shop.id) + '\n' + (shop.address || '')); } // Recherche déclenchée par UI document.getElementById('search').addEventListener('click', async function() { const zip = (document.getElementById('zip').value || '').trim(); if (!zip) { alert('Saisir un code postal'); return; } document.getElementById('status').textContent = 'Recherche...'; try { const shops = await fetchShops(zip); currentShops = shops || []; renderShops(currentShops); document.getElementById('status').textContent = (currentShops.length || 0) + ' résultat(s)'; } catch (err) { document.getElementById('status').textContent = 'Erreur: ' + err.message; console.error(err); } }); // Auto search initial (pour test) document.addEventListener('DOMContentLoaded', function() { if (!document.getElementById('zip').value) document.getElementById('zip').value = ''; if (!CONFIG.USE_BACKEND) { document.getElementById('zip').value = '75001'; document.getElementById('search').click(); } }); // Sécurité: écoute des messages entrants (optionnel) window.addEventListener('message', function(ev) { const msg = ev.data || {}; if (msg && msg.type === 'mr_open' && typeof msg.idx === 'number') { var el = document.querySelector('.shop[data-idx="' + msg.idx + '"]'); if (el) el.click(); } }); </script> </body> </html> -------------------------------------------------------------------

