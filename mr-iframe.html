<!doctype html> <html lang="fr"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width,initial-scale=1" /> <title>MR iframe</title> <style> body{font-family:system-ui,Arial;margin:8px;background:#fff} #mr-widget{min-height:260px;border:1px solid #e5e7eb;padding:12px;border-radius:6px;background:#fff} #mr_info_box{margin-top:10px;font-size:14px;color:#111} #mr-log{margin-top:8px;font-size:12px;color:#666} </style> </head> <body> <div id="mr-widget">Chargement du sélecteur Mondial Relay…</div> <div id="mr-log" aria-hidden="true"></div> <script> (function(){ // -------- CONFIG globale -------- window.MR_OPTIONS = { Target: '#mr-widget', Brand: 'CC2370D7', Country: 'FR', DisplayMapInfo: true }; // -------- helper pour logs visibles et console -------- function appendLog(msg){ try{ console.log('mr-iframe:', msg); var el = document.getElementById('mr-log'); if(el) el.textContent += (el.textContent ? '\n' : '') + msg; }catch(e){} } // -------- détecte l'origine parent de manière robuste -------- var parentOrigin = '*'; try{ if(document.referrer){ parentOrigin = (new URL(document.referrer)).origin || '*'; } }catch(e){ parentOrigin = '*'; } appendLog('parentOrigin=' + parentOrigin); function postToParent(msg){ try { // envoie avec origine détectée — évite les erreurs "target origin does not match" parent.postMessage(msg, parentOrigin); } catch(e){ appendLog('postToParent failed: ' + e); try { parent.postMessage(msg, '*'); } catch(e2){/* silent */ } } } function onSelectPoint(data){ postToParent({ type:'mr_selected', data: data }); try { var id = data.ID || data.NumPointRelais || data.PUPNumber || data.id || ""; var info = document.getElementById('mr_info_box'); if(!info){ info = document.createElement('div'); info.id = 'mr_info_box'; document.body.appendChild(info); } info.textContent = 'Point sélectionné : ' + (id || '[sans ID]'); } catch(e){} } // -------- chargement séquentiel des scripts (pas de fetch) -------- function loadScript(src, cb){ var s = document.createElement('script'); s.src = src; // forcer l'exécution synchronisée de l'ordre d'appel par onload chaining s.async = false; s.onload = function(){ appendLog('Script loaded: ' + src); cb && cb(null); }; s.onerror = function(){ appendLog('Script load error: ' + src); cb && cb(new Error('Erreur chargement ' + src)); }; document.head.appendChild(s); } // Démarre la séquence de chargement loadScript('https://code.jquery.com/jquery-3.6.0.min.js', function(err1){ if(err1){ document.getElementById('mr-widget').textContent = 'Erreur chargement jQuery'; postToParent({ type:'mr_error', message:'Erreur chargement jQuery' }); return; } appendLog('jQuery présent: ' + (typeof window.jQuery !== 'undefined')); // charge la librairie MR directement loadScript('https://widget.mondialrelay.com/parcelshop-picker/jquery.plugin.mondialrelay.parcelshoppicker.min.js', function(err2){ if(err2){ document.getElementById('mr-widget').textContent = 'Erreur chargement MR script'; postToParent({ type:'mr_error', message:'Erreur chargement MR script' }); return; } try { appendLog('Tentative d\'initialisation du plugin MR'); if(window.jQuery && typeof jQuery.fn.MR_ParcelShopPicker === 'function'){ jQuery(window.MR_OPTIONS.Target).MR_ParcelShopPicker(Object.assign({}, window.MR_OPTIONS, { OnParcelShopSelected: onSelectPoint, OnNoResultReturned: function(){ postToParent({ type:'mr_no_result' }); } })); appendLog('Initialisation MR via jQuery plugin demandée'); postToParent({ type:'mr_iframe_loaded', status:'ok' }); } else if (typeof MR_ParcelShopPicker === 'function') { MR_ParcelShopPicker(Object.assign({}, window.MR_OPTIONS, { OnParcelShopSelected: onSelectPoint })); appendLog('Initialisation MR via fonction globale demandée'); postToParent({ type:'mr_iframe_loaded', status:'ok' }); } else { document.getElementById('mr-widget').textContent = 'Plugin MR non disponible.'; appendLog('Plugin MR non trouvé après chargement du script.'); postToParent({ type:'mr_error', message:'Plugin MR non trouvé après load' }); } } catch(e){ document.getElementById('mr-widget').textContent = 'Init error: ' + e; appendLog('Erreur init MR: ' + e); postToParent({ type:'mr_error', message: String(e) }); } }); }); // timeout supplémentaire si rien ne se passe (utile pour debug) setTimeout(function(){ appendLog('Timeout check: jQuery=' + (typeof window.jQuery) + ' MRfn=' + !!(window.jQuery && jQuery.fn && jQuery.fn.MR_ParcelShopPicker)); }, 8000); })(); </script> </body> </html>


