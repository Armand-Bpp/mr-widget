<!doctype html> <html lang="fr"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width,initial-scale=1" /> <title>MR iframe</title> <style> body{font-family:system-ui,Arial;margin:8px;background:#fff} #mr-widget{min-height:260px;border:1px solid #e5e7eb;padding:12px;border-radius:6px;background:#fff} #mr_info_box{margin-top:10px;font-size:14px;color:#111} </style> </head> <body> <div id="mr-widget">Chargement du sélecteur Mondial Relay…</div> <script> (function(){ // === CONFIG (exposé globalement pour debug et pour l'init) === window.MR_OPTIONS = { Target: '#mr-widget', Brand: 'CC2370D7', Country: 'FR', DisplayMapInfo: true }; function logDebug() { try { console.log('MR debug — MR_OPTIONS =', window.MR_OPTIONS); } catch(e) {} } function loadScript(src, cb){ var s = document.createElement('script'); s.src = src; // On charge en async pour ne pas bloquer l'affichage, mais on attend onload pour l'init s.async = true; s.onload = function(){ console.log('Script loaded:', src); cb && cb(null); }; s.onerror = function(){ console.error('Script load error:', src); cb && cb(new Error('Erreur chargement ' + src)); }; document.head.appendChild(s); } function postToParent(msg){ try { parent.postMessage(msg, '*'); } catch(e) {} } function onSelectPoint(data){ postToParent({ type:'mr_selected', data: data }); try { var id = data.ID || data.NumPointRelais || data.PUPNumber || data.id || ""; var info = document.getElementById('mr_info_box'); if(!info){ info = document.createElement('div'); info.id = 'mr_info_box'; document.body.appendChild(info); } info.textContent = 'Point sélectionné : ' + (id || '[sans ID]'); } catch(e){} } // Charge jQuery, puis le plugin MR, puis initialise loadScript('https://code.jquery.com/jquery-3.6.0.min.js', function(err1){ if(err1){ document.getElementById('mr-widget').textContent = 'Erreur chargement jQuery'; return; } // debug console.log('jQuery présent:', typeof window.jQuery !== 'undefined'); loadScript('https://widget.mondialrelay.com/parcelshop-picker/jquery.plugin.mondialrelay.parcelshoppicker.min.js', function(err2){ if(err2){ document.getElementById('mr-widget').textContent = 'Erreur chargement MR script'; return; } try { logDebug(); if(window.jQuery && typeof jQuery.fn.MR_ParcelShopPicker === 'function'){ jQuery(window.MR_OPTIONS.Target).MR_ParcelShopPicker(Object.assign({}, window.MR_OPTIONS, { OnParcelShopSelected: onSelectPoint, OnNoResultReturned: function(){ postToParent({ type:'mr_no_result' }); } })); console.log('Initialisation MR via jQuery plugin demandée'); } else if (typeof MR_ParcelShopPicker === 'function') { MR_ParcelShopPicker(Object.assign({}, window.MR_OPTIONS, { OnParcelShopSelected: onSelectPoint })); console.log('Initialisation MR via fonction globale MR_ParcelShopPicker demandée'); } else { document.getElementById('mr-widget').textContent = 'Plugin MR non disponible.'; console.error('Plugin MR non trouvé après chargement du script.'); } } catch(e){ document.getElementById('mr-widget').textContent = 'Init error: ' + e; console.error('Erreur init MR:', e); } }); }); // indique au parent que l'iframe est chargé (utile pour debug) try { parent.postMessage({ type:'mr_iframe_loaded' }, '*'); } catch(e){} })(); </script> </body> </html>

