<!doctype html> <html lang="fr"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width,initial-scale=1" /> <title>MR Picker — IFrame</title> <style> body{font-family:Arial,Helvetica,sans-serif;margin:12px;color:#111} h1{font-size:18px;color:#8b1f4a} .relay{border:1px solid #eee;padding:10px;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center} .meta{font-size:13px;color:#444} .btn{background:#8b1f4a;color:white;border:0;padding:6px 10px;border-radius:4px;cursor:pointer} .info{font-size:13px;color:#666;margin-top:10px} #search{padding:6px;border:1px solid #ddd;border-radius:4px} #status{margin-left:8px;color:#666} </style> </head> <body> <h1>Sélectionner un Point Relais</h1> <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"> <input id="zip" placeholder="Code postal (ex: 75001)" style="padding:6px;border:1px solid #ddd;border-radius:4px" /> <button id="searchBtn" class="btn">Rechercher (mock)</button> <span id="status" class="info">mode: demo</span> </div> <div id="list"></div> <div class="info" style="margin-top:14px"> Si le parent supporte l'intégration, la sélection sera envoyée automatiquement au parent. Sinon clique sur "Copier" et colle dans le formulaire. </div> <script> // CONFIG — replace TARGET_ORIGIN with the origin of the parent page (Square) // In development or if unsure you can leave '*' but replace in production const TARGET_ORIGIN = '*'; // => replace by e.g. 'https://checkout.squaresite.com' function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); } // Mock search results (replace by real backend if you ever add one) function mockResults(zip){ return [ { id:'MR-001', name:'Boulangerie Dupont', address1:'12 RUE DE LA GARE', address2:'', zip:zip||'75001', city:'PARIS', country:'FR', phone:'0123456789', lat:48.8566, lng:2.3522}, { id:'MR-002', name:'Presse Victor', address1:'5 AVENUE VICTOR HUGO', address2:'', zip:zip||'75001', city:'PARIS', country:'FR', phone:'0123456780', lat:48.8600, lng:2.3450}, { id:'MR-003', name:'Locker Station X', address1:'30 RUE DES FLEURS', address2:'', zip:zip||'75001', city:'PARIS', country:'FR', phone:'0000000000', lat:48.8510, lng:2.3600} ]; } const listEl = document.getElementById('list'); const statusEl = document.getElementById('status'); function render(list){ listEl.innerHTML = ''; list.forEach((r, idx)=>{ const div = document.createElement('div'); div.className = 'relay'; div.innerHTML = '<div><strong>'+escapeHtml(r.name)+'</strong><div class="meta">'+escapeHtml(r.address1)+' '+escapeHtml(r.zip)+' '+escapeHtml(r.city)+'</div></div>'; const right = document.createElement('div'); const selectBtn = document.createElement('button'); selectBtn.className='btn'; selectBtn.textContent='Sélectionner'; selectBtn.addEventListener('click', ()=> choose(r)); right.appendChild(selectBtn); const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.style.marginLeft='6px'; copyBtn.textContent='Copier'; copyBtn.addEventListener('click', ()=> copyToClipboard(r)); right.appendChild(copyBtn); div.appendChild(right); listEl.appendChild(div); }); } function sendToParent(relay){ const msg = { type:'mr_selected', data: relay }; try { window.parent.postMessage(msg, TARGET_ORIGIN); statusEl.textContent = 'Sélection envoyée au parent'; } catch(e){ console.error(e); statusEl.textContent = 'Impossible d\'envoyer au parent'; } } function choose(relay){ // save locally in iframe try { localStorage.setItem('mr_selected_relay', JSON.stringify(relay)); } catch(e){} sendToParent(relay); // show a little confirmation statusEl.textContent = 'Point relais sélectionné : ' + relay.name; } function copyToClipboard(relay){ const text = relay.address1 + (relay.address2 ? ' ' + relay.address2 : '') + ', ' + relay.zip + ' ' + relay.city + ' (tel: ' + (relay.phone||'') + ')'; navigator.clipboard?.writeText(text).then(()=> { statusEl.textContent = 'Adresse copiée dans le presse-papiers — collez-la dans votre checkout'; }).catch(()=> { // fallback const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); statusEl.textContent = 'Adresse copiée (fallback)'; } catch(e){ statusEl.textContent = 'Impossible de copier automatiquement, sélectionne manuellement: ' + text; } ta.remove(); }); } document.getElementById('searchBtn').addEventListener('click', ()=>{ const zip = document.getElementById('zip').value.trim() || '75001'; statusEl.textContent = 'Recherche...'; setTimeout(()=>{ // simulate fetch const res = mockResults(zip); render(res); statusEl.textContent = res.length + ' résultat(s)'; }, 300); }); // When loaded, show default list window.addEventListener('DOMContentLoaded', ()=>{ const saved = localStorage.getItem('mr_selected_relay'); if (saved) { statusEl.textContent = 'Sélection précédente disponible'; } render(mockResults('75001')); }); // Optional: listen if parent asks to open a specific idx window.addEventListener('message', (ev)=>{ const msg = ev.data || {}; if (msg && msg.type === 'mr_open' && typeof msg.idx === 'number'){ const arr = mockResults(''); const r = arr[msg.idx]; if (r) choose(r); } }, false); </script> </body> </html>
