<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MR ParcelShop Picker — iframe</title>
  <style>
    html,body { height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; background:#fff; color:#222; }
    .wrap { max-width:980px; margin:18px auto; padding:18px; box-sizing:border-box; }
    #mr-widget { min-height:360px; border:1px dashed #ddd; padding:12px; border-radius:6px; }
    .info { margin:12px 0; color:#555; font-size:14px; }
    .debug { margin-top:14px; background:#f7f7f7; padding:10px; border-radius:6px; font-size:13px; color:#333; white-space:pre-wrap; max-height:240px; overflow:auto; }
    .controls { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #cfcfcf; background:#fff; cursor:pointer; }
    button.primary { background:#8b2350; color:#fff; border-color:#6b173a; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Widget Mondial Relay — ParcelShop Picker (iframe)</h2>

    <div class="info">
      Cette page charge le plugin MR et initialise le sélecteur dans #mr-widget.<br>
      Quand un relais est sélectionné, un message postMessage est envoyé au parent/opener.
    </div>

    <div id="mr-widget">Chargement du sélecteur Mondial Relay…</div>

    <div class="controls">
      <button id="btn-debug" title="Affiche les infos de debug">Afficher debug console</button>
      <button id="btn-send" class="primary" title="Envoyer manuellement la sélection au parent">Envoyer sélection au parent</button>
      <button id="btn-list" title="Lister éléments candidats (pour debug)">Lister candidats</button>
    </div>

    <div class="debug" id="debug">Debug : prêt.</div>
  </div>

  <script>
  // ====== CONFIG À ADAPTER si besoin ======
  // Remplace 'CC2370D7' par ton code enseigne fourni par Mondial Relay si nécessaire.
  window.MR_OPTIONS = {
    brand: 'CC2370D7'
    // autres options possibles : language: 'FR', country: 'FR', etc.
  };

  // targetOrigin pour postMessage. Peut être passé en param URL ?targetOrigin=https://ton-site.example
  const urlParams = new URLSearchParams(location.search);
  const ALLOWED_TARGET = urlParams.get('targetOrigin') || '*';

  // zone debug
  const dbgEl = document.getElementById('debug');
  function appendDebug(msg) {
    const time = new Date().toISOString().split('T')[1].slice(0,8);
    const line = `[${time}] ${msg}`;
    console.log(line);
    dbgEl.textContent += '\n' + line;
    dbgEl.scrollTop = dbgEl.scrollHeight;
  }

  appendDebug('Initialisation MR iframe (locale)');

  // ====== CHARGEMENT DYNAMIQUE DE JQUERY ET DU PLUGIN MR ======
  function loadScript(src, onload, onerror) {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = onload;
    s.onerror = onerror || function(){ appendDebug('Échec chargement script: ' + src); };
    document.head.appendChild(s);
  }

  // Chargement jQuery puis plugin MR
  appendDebug('Chargement jQuery...');
  loadScript('https://code.jquery.com/jquery-3.6.0.min.js', function() {
    appendDebug('jQuery chargé: ' + (typeof jQuery !== 'undefined'));
    const mrPluginUrl = 'https://widget.mondialrelay.com/parcelshop-picker/jquery.plugin.mondialrelay.parcelshoppicker.min.js';
    appendDebug('Chargement plugin MR: ' + mrPluginUrl);
    loadScript(mrPluginUrl, function() {
      appendDebug('Plugin MR chargé. jQuery.fn.MR_ParcelShopPicker=' + !!(jQuery && jQuery.fn && jQuery.fn.MR_ParcelShopPicker));
      initMR();
    }, function() {
      appendDebug('Erreur chargement plugin MR (CORS/404/blocked).');
      document.getElementById('mr-widget').innerText = 'Plugin MR non chargé : vérifie CORS / plugin URL.';
    });
  }, function() {
    appendDebug('Erreur chargement jQuery.');
    document.getElementById('mr-widget').innerText = 'Impossible de charger jQuery.';
  });

  // ====== INITIALISATION DU WIDGET SI POSSIBLE ======
  function initMR() {
    try {
      if (window.jQuery && jQuery.fn && jQuery.fn.MR_ParcelShopPicker) {
        appendDebug('Initialisation du sélecteur MR avec MR_OPTIONS: ' + JSON.stringify(window.MR_OPTIONS));
        try {
          jQuery('#mr-widget').MR_ParcelShopPicker(window.MR_OPTIONS);
          appendDebug('Appel MR_ParcelShopPicker() effectué.');
        } catch (e) {
          appendDebug("Erreur lors de l'appel MR_ParcelShopPicker(): " + e);
        }
      } else {
        appendDebug('MR_ParcelShopPicker non disponible.');
      }
    } catch (e) {
      appendDebug('Erreur initMR: ' + e);
    }

    // Après l'initialisation : installer l'observateur pour détecter la sélection utilisateur
    installSelectionObserver();
  }

  // ====== LOGIQUE POUR DÉTECTER LA SÉLECTION ET L'ENVOYER ======
  function findSelectedCandidate(root) {
    // Plusieurs heuristiques pour trouver un ID / label de Point Relais dans le DOM
    // Retourne {id:, label:, rawElement: el} ou null
    root = root || document;

    // 1) inputs cachés classiques
    const candidates = [
      'input[name="PSPID"]',
      'input[name="parcelshop_id"]',
      'input[name="selectedParcelShopId"]',
      'input#psp_id',
      'input[name="selected_psp"]'
    ];
    for (const sel of candidates) {
      const inp = root.querySelector(sel);
      if (inp && inp.value) {
        return { id: inp.value, label: inp.getAttribute('data-label') || inp.value, rawElement: inp };
      }
    }

    // 2) éléments marqués data-*
    const elData = root.querySelector('[data-psp-id], [data-parcelshop-id], [data-id]');
    if (elData) {
      const id = elData.getAttribute('data-psp-id') || elData.getAttribute('data-parcelshop-id') || elData.getAttribute('data-id');
      if (id) return { id: id, label: elData.textContent.trim().slice(0,120), rawElement: elData };
    }

    // 3) éléments avec classe "selected" ou "mr-selected"
    const selEl = root.querySelector('.selected, .mr-selected, .psp-selected, .parcelshop-selected');
    if (selEl) {
      const possibleId = selEl.getAttribute('data-id') || selEl.getAttribute('data-psp-id') || (selEl.querySelector('[data-psp-id]') && selEl.querySelector('[data-psp-id]').getAttribute('data-psp-id'));
      if (possibleId) return { id: possibleId, label: selEl.textContent.trim().slice(0,120), rawElement: selEl };
    }

    // 4) inputs radio sélectionnés
    const radio = root.querySelector('input[type="radio"]:checked');
    if (radio) {
      const val = radio.value || radio.getAttribute('data-id') || radio.getAttribute('data-psp-id');
      if (val) return { id: val, label: radio.getAttribute('data-label') || radio.value || (radio.closest('label') && radio.closest('label').textContent && radio.closest('label').textContent.trim()), rawElement: radio };
    }

    // rien trouvé
    return null;
  }

  function sendSelectionToParent(obj) {
    // obj = {id, label}
    const message = { source: 'mr-iframe', type: 'parcelshop-selected', payload: obj };
    appendDebug('Envoi postMessage vers parent/opener: ' + JSON.stringify(message));
    try {
      // si ouvert en popup et opener présent -> envoyer à opener
      if (window.opener && !window.opener.closed) {
        try {
          window.opener.postMessage(message, ALLOWED_TARGET);
          appendDebug('Message envoyé à window.opener (popup).');
        } catch (e) {
          appendDebug('Erreur envoi à opener: ' + e);
        }
      }
      // aussi envoyer au parent (iframe)
      if (window.parent && window.parent !== window) {
        try {
          window.parent.postMessage(message, ALLOWED_TARGET);
          appendDebug('Message envoyé à window.parent (iframe).');
        } catch (e) {
          appendDebug('Erreur envoi à parent: ' + e);
        }
      }
    } catch (e) {
      appendDebug('Erreur postMessage: ' + e);
    }
  }

  // Observateur DOM : surveille #mr-widget pour éléments candidats et click sur éléments
  function installSelectionObserver() {
    const target = document.getElementById('mr-widget') || document;
    appendDebug('Installation MutationObserver sur #mr-widget');
    try {
      // envoi si une sélection est détectée automatiquement après mutation
      const mo = new MutationObserver(function(mutations) {
        // petit délai pour laisser le plugin finaliser l'état sélectionné
        setTimeout(() => {
          const found = findSelectedCandidate(target);
          if (found) {
            appendDebug('Sélection détectée via MutationObserver: ' + JSON.stringify(found));
            // envoi automatique
            sendSelectionToParent({ id: found.id, label: found.label || '' });
          }
        }, 250);
      });

      mo.observe(target, { childList: true, subtree: true, attributes: true, characterData: true });

      // clic global : si utilisateur clique sur un élément candidat, on tente d'envoyer
      target.addEventListener('click', function(evt) {
        setTimeout(() => {
          const found = findSelectedCandidate(target);
          if (found) {
            appendDebug('Sélection détectée après click: ' + JSON.stringify(found));
            sendSelectionToParent({ id: found.id, label: found.label || '' });
          }
        }, 180);
      }, true);

      appendDebug('Observer et listeners installés.');
    } catch (e) {
      appendDebug('Erreur installSelectionObserver: ' + e);
    }
  }

  // ====== FONCTION DE LISTING (DEBUG) ======
  function listCandidates() {
    const target = document.getElementById('mr-widget') || document;
    const infos = [];

    // chercher inputs radio
    target.querySelectorAll('input[type="radio"]').forEach(r => {
      infos.push({
        kind: 'radio',
        val: r.value,
        dataId: r.getAttribute('data-psp-id') || r.getAttribute('data-id') || null,
        label: r.getAttribute('data-label') || (r.closest('label') && r.closest('label').textContent && r.closest('label').textContent.trim()) || null,
        checked: r.checked
      });
    });

    // éléments data-psp-id
    target.querySelectorAll('[data-psp-id]').forEach(el => {
      infos.push({ kind:'data-psp', val: el.getAttribute('data-psp-id'), text: el.textContent.trim().slice(0,120) });
    });

    // éléments avec classe contenant "psp" ou "parcelshop"
    target.querySelectorAll('[class*="psp"], [class*="parcelshop"], [class*="parcel-shop"]').forEach(el => {
      infos.push({ kind:'class-psp', class: el.className, text: el.textContent.trim().slice(0,120) });
    });

    // inputs cachés
    ['PSPID','parcelshop_id','selectedParcelShopId','selected_psp','psp_id'].forEach(name => {
      const inp = target.querySelector('input[name="' + name + '"]');
      if (inp) infos.push({ kind:'hidden-input', name: name, value: inp.value, dataLabel: inp.getAttribute('data-label') || null });
    });

    appendDebug('CANDIDATS TROUVES: ' + JSON.stringify(infos));
    return infos;
  }

  // ====== BOUTONS DE DEBUG ======
  document.getElementById('btn-debug').addEventListener('click', function() {
    appendDebug('MR_OPTIONS: ' + JSON.stringify(window.MR_OPTIONS));
    appendDebug('location.href: ' + location.href);
    appendDebug('Allowed target for postMessage: ' + ALLOWED_TARGET);
    appendDebug('jQuery present: ' + (typeof jQuery !== 'undefined'));
    appendDebug('MR plugin available: ' + !!(jQuery && jQuery.fn && jQuery.fn.MR_ParcelShopPicker));
  });

  document.getElementById('btn-send').addEventListener('click', function() {
    const found = findSelectedCandidate(document);
    if (found) {
      appendDebug('Envoi manuel de la sélection: ' + JSON.stringify(found));
      sendSelectionToParent({ id: found.id, label: found.label || '' });
    } else {
      appendDebug('Aucune sélection détectée lors de l\'envoi manuel. Lister les candidats possibles.');
      listCandidates();
    }
  });

  document.getElementById('btn-list').addEventListener('click', function() {
    listCandidates();
  });

  // ====== ECOUTE DES MESSAGES INCOMING (optionnel) ======
  window.addEventListener('message', function(evt) {
    try {
      const m = evt.data || {};
      if (m && m.cmd === 'ping') {
        const reply = { source: 'mr-iframe', type: 'pong', ts: Date.now() };
        evt.source.postMessage(reply, ALLOWED_TARGET);
        appendDebug('Répondu pong au parent');
      }
    } catch (e) {
      appendDebug('Erreur gestion message entrant: ' + e);
    }
  });

  appendDebug('Script chargé — en attente du plugin MR si disponible.');
  </script>
</body>
</html>
