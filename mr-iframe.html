<!-- mr-iframe.html --> <!doctype html> <html lang="fr"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width,initial-scale=1" /> <title>MR Widget — iframe</title> <style> html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif} #root{height:100%;box-sizing:border-box;padding:12px} #header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px} #title{font-size:16px;font-weight:600} #controls{display:flex;gap:8px} .btn{background:#0b64d6;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px} .btn.secondary{background:#6b7280} #status{font-size:13px;color:#333;margin-top:8px} #fallback{margin-top:10px;padding:8px;border-radius:6px;background:#f8fafc;color:#111;font-size:13px} pre{white-space:pre-wrap;word-break:break-word} </style> </head> <body> <div id="root"> <div id="header"> <div id="title">Sélecteur point relais (Mondial Relay)</div> <div id="controls"> <button id="btn-debug" class="btn secondary">Debug</button> <button id="btn-copy" class="btn">Copier dernière sélection</button> </div> </div> <!-- Conteneur où le widget MR injectera son UI --> <div id="mr-widget-container" style="height:calc(100% - 86px);min-height:320px;border:1px solid #e5e7eb;border-radius:6px;padding:8px;overflow:auto"> <div id="mr-loading">Chargement du widget Mondial Relay…</div> </div> <div id="status" aria-live="polite"></div> <div id="fallback" style="display:none"> Si l'automatisation échoue, copie-colle les informations ci‑dessous dans le formulaire : <pre id="fallback-content">Aucune sélection</pre> </div> </div> <script> /* mr-iframe.html - Charge asynchrone du script Mondial Relay - Initialise le plugin si disponible - Envoi de postMessage vers parent : { type: "mr_selected", data: { id, name, address1, address2, zip, city, country, phone } } Configuration possible via query string : ?parentOrigin=https://ma-boutique.example -> origine cible autorisée pour postMessage (RECOMMANDÉ) ?mrUrl=https://widget.mondialrelay.com -> URL du widget (par défaut) ?debug=true -> active les logs de debug dans l'UI */ (function(){ 'use strict'; // --- Utils --- function qs(name, def) { const p = new URLSearchParams(location.search); return p.get(name) || def; } function log(...a){ if(DEBUG) console.log('[mr-widget]', ...a); } function safeJSON(o){ try{return JSON.stringify(o)}catch(e){return String(o)} } // --- Configuration --- const MR_URL = qs('mrUrl', 'https://widget.mondialrelay.com').replace(/\/$/, ''); const PARENT_ORIGIN = qs('parentOrigin', '*'); // recommandation : passe l'origine de ta page parent const DEBUG = qs('debug', '') === 'true'; const CONTAINER_ID = 'mr-widget-container'; // --- DOM refs --- const container = document.getElementById(CONTAINER_ID); const statusEl = document.getElementById('status'); const loadingEl = document.getElementById('mr-loading'); const fallbackBox = document.getElementById('fallback'); const fallbackContent = document.getElementById('fallback-content'); const btnCopy = document.getElementById('btn-copy'); const btnDebug = document.getElementById('btn-debug'); let lastSelection = null; // --- Post message to parent (use PARENT_ORIGIN if provided) --- function sendToParent(payload){ try{ const target = PARENT_ORIGIN === '*' ? '*' : PARENT_ORIGIN; window.parent.postMessage(payload, target); status('Envoi au parent ✓'); log('postMessage ->', target, payload); }catch(e){ status('Erreur d\'envoi au parent: ' + (e && e.message || e)); console.error(e); } } function status(txt){ statusEl.textContent = txt; } // --- Normaliser les données d'un "point relais" --- function normalizeSelection(raw){ // raw peut avoir de nombreuses formes ; on essaie d'en extraire les champs usuels. const r = raw || {}; const out = { id: r.id || r.ID || r.code || r.Code || r.numero || null, name: r.name || r.nom || r.Name || r.shopName || null, address1: r.address1 || r.addr1 || r.adress || r.address || null, address2: r.address2 || r.addr2 || r.complement || null, zip: r.zip || r.postcode || r.codePostal || r.cp || r.postalCode || null, city: r.city || r.ville || r.locality || null, country: r.country || r.pays || r.countryCode || 'FR', phone: r.phone || r.telephone || r.tel || null, raw: r }; return out; } // --- Try to extract from DOM (heuristic fallback) --- function extractFromDOM(containerEl){ if(!containerEl) return null; // heuristiques communes : éléments marqués .selected, .mr-selected, data attributes, etc. const selectors = [ '[data-ps-id].selected', '[data-ps-id].mr-selected', '[data-ps-id]', '.selected[data-ps-id]', '.mr-selected[data-ps-id]', '.selected', '.mr-selected' ]; for(const s of selectors){ const el = containerEl.querySelector(s); if(!el) continue; // tenter d'extraire texte par lignes const text = el.innerText || el.textContent || ''; // heuristique simple : chercher CP (5 chiffres) + ville const zipMatch = text.match(/(\b\d{5}\b)/); const zip = zipMatch ? zipMatch[1] : null; // ligne adresse : première ligne non vide const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const maybeAddress1 = lines[0] || null; const maybeName = lines.length>1 ? lines[1] : null; const maybeCity = lines.find(l => zip && l.includes(zip)) || lines.find(l => /[A-Za-z\u00C0-\u017F\- ]{2,}/.test(l)); return { id: el.getAttribute('data-ps-id') || null, name: maybeName, address1: maybeAddress1, address2: null, zip: zip, city: maybeCity, country: 'FR', phone: null, _detectedText: text }; } // autre heuristique : inputs visibles (address fields) const inputs = containerEl.querySelectorAll('input, span, li, p'); if(inputs && inputs.length){ // très simple : chercher des labels const allText = Array.from(inputs).map(i => (i.innerText||i.value||'')).join('\n'); const zipMatch = allText.match(/(\b\d{5}\b)/); return zipMatch ? { address1: null, zip: zipMatch[1], city: null } : null; } return null; } // --- Centralise la notification d'une sélection détectée --- function notifySelection(raw){ const norm = normalizeSelection(raw); lastSelection = norm; // mettre à jour fallback UI fallbackContent.textContent = [ 'ID: ' + (norm.id || ''), 'Nom: ' + (norm.name || ''), 'Adresse1: ' + (norm.address1 || ''), 'Adresse2: ' + (norm.address2 || ''), 'CP: ' + (norm.zip || ''), 'Ville: ' + (norm.city || ''), 'Pays: ' + (norm.country || ''), 'Téléphone: ' + (norm.phone || '') ].join('\n'); fallbackBox.style.display = 'block'; // Envoyer le message au parent sendToParent({ type: 'mr_selected', data: norm }); } // --- Load external script dynamically --- function loadScript(src){ return new Promise((resolve,reject)=>{ const s = document.createElement('script'); s.src = src; s.async = true; s.onload = ()=>resolve(); s.onerror = (e)=>reject(new Error('Échec chargement script: ' + src)); document.head.appendChild(s); }); } // --- Initialize MR plugin if available --- async function initMR(){ try{ status('Récupération de la version MR…'); // Option: si on veut récupérer /version, on peut, mais on préfère charger /js directement si version non connue. // Ici on essaie d'appeler /version puis /js?v=VERSION (comme le loader officiel). let version = null; try { const vRes = await fetch(MR_URL + '/version', { cache: 'no-cache' }); if(vRes.ok) version = (await vRes.text()).trim(); log('MR version', version); } catch(e) { log('Impossible de récupérer /version, on tente de charger /js directement', e); } const scriptUrl = version ? MR_URL + '/js?v=' + encodeURIComponent(version) : MR_URL + '/js'; status('Chargement du script MR…'); await loadScript(scriptUrl); status('Script MR chargé'); // Après chargement du script, initialiser le plugin dans #mr-widget-container // Si le plugin expose une méthode jQuery : $('#container').MR_ParcelShopPicker(options) // On va tenter plusieurs approches. const $ = window.jQuery; const containerEl = document.getElementById('mr-widget-container'); // Option pour passer callback : onSelect const initOptions = { // paramètres par défaut — adapte si besoin ou passe via querystring // Example: onSelect callback (si le plugin le prend) onSelect: function(item){ log('onSelect callback invoked', item); notifySelection(item); }, onSelectCallback: function(item){ // certains widgets ont un autre nom log('onSelectCallback invoked', item); notifySelection(item); } }; // 1) Si jQuery plugin disponible if($ && typeof $.fn !== 'undefined' && typeof $.fn.MR_ParcelShopPicker === 'function'){ try{ status('Initialisation du plugin MR (jQuery)…'); // Attacher le plugin au container $(containerEl).MR_ParcelShopPicker(initOptions); status('Plugin MR initialisé (jQuery)'); // Si le plugin fournit des événements personnalisés, on les écoute // Exemple hypothétique : $(containerEl).on('mr:select', handler) try { $(containerEl).on('mr:selected mr:select MR:select', function(ev, data){ log('plugin event mr:selected', ev, data); notifySelection(data); }); } catch(e){ /* ignore */ } return; } catch(e){ console.warn('Échec initialisation jQuery plugin', e); } } // 2) Si le script ajoute une API globale (heuristique) // Exemple : window.MondialRelayPicker && window.MondialRelayPicker.init(...) try{ if(window.MondialRelayPicker && typeof window.MondialRelayPicker.init === 'function'){ status('Initialisation via MondialRelayPicker.init'); window.MondialRelayPicker.init(containerEl, Object.assign({}, initOptions, { onSelect: function(item){ notifySelection(item); } })); return; } } catch(e){ /* ignore */ } // 3) Écoute d'événements DOM personnalisés (fallback) document.addEventListener('mr:selected', function(ev){ log('DOM custom event mr:selected', ev.detail); notifySelection(ev.detail); }); // 4) MutationObserver fallback pour detections visuelles/DOM status('Observation DOM active (fallback)'); const mo = new MutationObserver(function(muts){ // à chaque mutation, tenter d'extraire une sélection const detected = extractFromDOM(containerEl); if(detected){ log('Sélection détectée par DOM:', detected); notifySelection(detected); // si on a trouvé, on peut disconnect ou continuer selon besoin // mo.disconnect(); } }); mo.observe(containerEl, { childList:true, subtree:true, attributes:true, characterData:true }); // 5) Ajouter un listener sur des clics boutons éventuels (délégation) containerEl.addEventListener('click', function(ev){ const targ = ev.target; // si l'élément cliqué contient un data-ps-id ou similaire const node = targ.closest && targ.closest('[data-ps-id], .select-point, .mr-select'); if(node){ const d = extractFromDOM(node) || { id: node.getAttribute('data-ps-id') || null, _hint: 'clic détecté' }; log('clic-> tentative extract', d); notifySelection(d); } }, true); status('Widget prêt (fallback actif)'); loadingEl.style.display = 'none'; } catch(err){ console.error('Erreur initialisation MR widget', err); status('Erreur chargement widget : ' + (err && err.message || err)); loadingEl.textContent = 'Impossible de charger le widget Mondial Relay.'; fallbackBox.style.display = 'block'; fallbackContent.textContent = 'Aucune sélection — widget indisponible.'; } } // --- Buttons --- btnCopy.addEventListener('click', function(){ if(!lastSelection){ status('Aucune sélection à copier'); return; } const text = [ lastSelection.name || '', lastSelection.address1 || '', lastSelection.address2 || '', (lastSelection.zip || '') + ' ' + (lastSelection.city || ''), lastSelection.country || '', 'Tel: ' + (lastSelection.phone || '') ].filter(Boolean).join('\n'); navigator.clipboard ? navigator.clipboard.writeText(text).then(function(){ status('Copié dans le presse-papiers'); }).catch(function(){ status('Échec copie'); }) : (function(){ try { document.execCommand('copy'); status('Copié (fallback)'); }catch(e){ status('Copie impossible'); } })(); }); btnDebug.addEventListener('click', function(){ alert('Debug info:\\nMR_URL=' + MR_URL + '\\nPARENT_ORIGIN=' + PARENT_ORIGIN + '\\nDEBUG=' + DEBUG); }); // --- Start --- initMR(); // Expose simple API pour debug depuis parent si besoin window.MR_WIDGET = { getLast: ()=> lastSelection, notify: (o)=> notifySelection(o) }; // Informer parent que l'iframe est prête (optionnel) window.parent.postMessage({ type: 'mr_iframe_ready', data: { url: location.href } }, PARENT_ORIGIN === '*' ? '*' : PARENT_ORIGIN); })(); </script> </body> </html>
