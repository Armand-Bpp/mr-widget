<!doctype html> <html lang="fr"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>MR Iframe - Test Leaflet (mock)</title> <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/> <style>html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}#map{height:360px}#list{max-height:200px;overflow:auto;margin-top:8px}.shop{padding:6px;border-bottom:1px solid #eee;cursor:pointer}.shop:hover{background:#f6f6f6}</style> </head> <body> <div style="padding:8px"> <div> <label>Code postal: <input id="zip" type="text" placeholder="75001" value="75001" /></label> <button id="search">Rechercher (mock)</button> <span id="status" style="margin-left:12px;color:#666"></span> </div> <div id="map"></div> <div id="list"></div> </div> <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> <script> // Mock data generator (pour test sans backend) function mockResults(zip){ return [ { id:'MR001', name:'Point Relais - Boulangerie Dupont', address:'12 rue de la Gare', zip, city:'Paris', lat:48.8566, lng:2.3522 }, { id:'MR002', name:'Point Relais - Presse Monde', address:'5 avenue Victor', zip, city:'Paris', lat:48.8600, lng:2.3450 }, { id:'MR003', name:'Locker - Station X', address:'30 rue des Fleurs', zip, city:'Paris', lat:48.8510, lng:2.3600 } ]; } const map = L.map('map').setView([48.8566,2.3522],12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map); const markers = L.layerGroup().addTo(map); let currentShops = []; function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); } function renderShops(shops){ markers.clearLayers(); const list = document.getElementById('list'); list.innerHTML=''; const bounds = []; shops.forEach((s,idx)=>{ const lat = parseFloat(s.lat), lng = parseFloat(s.lng); if(!lat||!lng) return; bounds.push([lat,lng]); const marker = L.marker([lat,lng]).addTo(markers); marker.bindPopup(`<strong>${escapeHtml(s.name)}</strong><br>${escapeHtml(s.address)}<br>${escapeHtml(s.zip)} ${escapeHtml(s.city)}<br><button data-idx="${idx}" class="select-btn">Sélectionner</button>`); const item = document.createElement('div'); item.className='shop'; item.dataset.idx=idx; item.innerHTML = `<strong>${escapeHtml(s.name)}</strong><div style="font-size:90%;color:#444">${escapeHtml(s.address)} ${escapeHtml(s.zip)} ${escapeHtml(s.city)}</div><div style="text-align:right"><button data-idx="${idx}" class="select-btn">Sélectionner</button></div>`; item.addEventListener('click',()=>{ marker.openPopup(); map.panTo([lat,lng]); }); list.appendChild(item); }); if(bounds.length) map.fitBounds(bounds,{padding:[40,40],maxZoom:15}); document.querySelectorAll('.select-btn').forEach(btn=>btn.addEventListener('click',ev=>{ ev.stopPropagation(); chooseShop(parseInt(btn.dataset.idx)); })); } function chooseShop(idx){ const shop = currentShops[idx]; if(!shop) return; // envoi au parent (Square) -- remplace * par l'origin de ton site Square si possible window.parent.postMessage({ type:'mr_selected', data:shop }, '*'); alert('Point relais sélectionné:\\n' + (shop.name||shop.id) + '\\n' + (shop.address||'')); } document.getElementById('search').addEventListener('click', ()=>{ const zip = document.getElementById('zip').value.trim(); if(!zip) return alert('Saisir un code postal'); document.getElementById('status').textContent='Recherche (mock)...'; currentShops = mockResults(zip); renderShops(currentShops); document.getElementById('status').textContent = currentShops.length + ' résultat(s) (mock)'; }); // init document.getElementById('search').click(); </script> </body> </html>
